spring:
  application:
    name: bigin

  profiles:
    active: local

  h2:
    console:
      enabled: true         # H2 Console 활성화
      path: /h2-console     # 접속 경로
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test   # 인메모리 DB
    username: sa
    password:

  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      group-id: notification-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.ghyinc.finance.domain.notification.dto"

server:
  port: 8080
  shutdown: graceful

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
    display-request-duration: true
    groups-order: DESC
    doc-expansion: none
  api-docs:
    path: /api-docs
    enabled: true
  show-actuator: false
  default-consumes-media-type: application/json
  default-produces-media-type: application/json

resilience4j:
  circuitbreaker:
    instances:
      default:

        # Sliding Window 설정
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10           # 최근 10번 호출 기준
        minimum-number-of-calls: 5        # 최소 5번 호출 후 통계

        # CLOSE -> OPEN 전환 조건
        failure-rate-threshold: 50        # 실패율 50% 이상이면 OPEN
        slow-call-rate-threshold: 50      # 느린 호출 50% 이상이면 OPEN
        slow-call-duration-threshold: 3s  # 3초 이상이면 느린 호출

        # OPEN 상태 유지 시간
        wait-duration-in-open-state: 30s  # OPEN 상태 30초 유지

        # HALF_OPEN 상태 설정
        permitted-number-of-calls-in-half-open-state: 3   # 3개 요청 테스트
        automatic-transition-from-open-to-half-open-enabled: true

        # HALF_OPEN -> CLOSE 또는 OPEN 전환
        max-wait-duration-in-half-open-state: 10s         # HALF_OPEN 최대 10초

        # 기록할 예외
        record-exceptions:
          - org.springframework.web.client.ResourceAccessException
          - org.springframework.web.client.HttpServerErrorException
          - java.net.ConnectException
          - java.net.SocketTimeoutException

        # 무시할 예외 (Circuit Breaker에 영향 안 줌)
        ignore-exceptions:
          - org.springframework.web.client.HttpClientErrorException.BadRequest
          - org.springframework.web.client.HttpClientErrorException.Unauthorized

  # Retry 설정
  retry:
    instances:
      default:
        max-attempts: 3
        wait-duration: 1s
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        max-wait-duration: 10s
        # ✅ 여기에 추가!
        retry-exceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.client.HttpServerErrorException
          - org.springframework.web.client.ResourceAccessException